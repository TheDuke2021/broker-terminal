







# BEST HACK 2023

## Сервис "Терминал Брокера" [Команда 3w]

Сервис "Терминал Брокера" - это сервис, позволяющий оперативно отображать информацию, получаемую от сервисов биржевой информации, а также реализующий возможность отправки команд, исполняющихся на стороне сервисов.

Используемые технологии:
  * TCP-сервер - Netty, Google Protocol Buffers;
  * HTTP-сервер - Spring MVC, Spring WebSockets;
  * Фронт-энд - HTML/CSS/JS + Bootstrap;
  * Прочие библиотеки - Jackson.

Для TCP-сервера был выбран фреймворк Netty, т.к. в нём есть встроенная поддержка протокола Google Protocol Buffers. WebSocket'ы используются для дуплексного общения HTTP-сервера с WEB GUI-клиентами. Т.к. в нашей команде никто не знал фронт-энд фреймворков (React, Vue, Angular), клиентская часть была написана на голом HTML/CSS/JS. Библиотека Jackson используется для кодирования и декодирования классов в JSON-формат.

## Реализованные возможности

Приложение реализует следующую архитектуру:

<img src="https://imgur.com/p97vpHA.jpg" alt="architecture" width="600" />

### TCP-сервер

  *  TCP-сервер слушает определённый порт и обрабатывает новые подключения. Если клиент не отправил запрос на _handshake_ в течение заданного времени (по условиям задачи 5 секунд) - сервер разрывает соединение;
  * TCP-сервер имеет свой список соединений, с которыми был совершён _handshake_. Если серверу поступает запрос от соединения, которого нет в этом списке, и при этом запрос не является _handshake'ом_ - запрос игнорируется;
  *  TCP-сервер имеет свой список запросов (_requests_), отправленных сервисам биржевой информации. Каждый запрос имеет свой уникальный номер `messageNum`. При каждом ответе от сервисов (_response'ов_) идёт проверка поля `messageNumAnswer`: если это поле не совпадает с полем `messageNum` ни одного из запросов, ответ игнорируется;
  *  При получении запроса от HTTP-сервера (на исполнение команды или получение статуса сервера) TCP-сервер перенаправляет запрос соответствующему сервису биржевой информации;
  *  У TCP-сервера есть свой уникальный идентификатор, который записывается в поля `receiver` и `sender` в заголовок сообщения (_Header_). Если TCP-серверу поступает запрос от сервиса биржевой информации, и идентификатор получателя не равен идентификатору TCP-сервера, то запрос игнорируется;
  * Поддержка полного и инкрементального обновления данных. TCP-сервер хранит и обрабатывает все данные, пришедшие от сервиса биржевой информации. Обработанные данные передаются HTTP-серверу.
  
### HTTP-сервер

  *  По запросу клиента предоставляется стартовая HTML-страница приложения. Также реализованы два канала _WebSocket'ов_, они доступны по адресам `/messages` и `/notifications`. По каналу `/messages` отравляются и принимаются сообщения от TCP-сервера, которые дальше отправляются сервисам биржевой информации. Канал `/notifications` служит для оповещения клиента, когда к TCP-серверу подсоединяется новый сервис (или отключается старый). В ответ на эти события HTML-страница динамически изменяется (обновляется список доступных сервисов);
  *  Реализован механизм оценки отставания отображаемой информации от полученной информации. Чтобы сообщению дойти от сервиса биржевой информации до конечного клиента, требуется время. Когда клиент получает сообщение, он сравнивает время получения сообщения с полем `timestamp` в заголовке сообщения (т.е. временем создания сообщения). Разница между этими двумя величинами - это и есть оценка отставания информации.
  
### Фронт-энд

  *  Список доступных сервисов биржевой информации;
  *  Адаптивный дизайн благодаря библиотеке _Bootstrap_. Отображение страницы подстраивается под конкретный девайс (компьютер, планшет, телефон);
  *  Динамическое изменение контента благодаря _WebSocket'ам_;
  *  Поддерживается два типа взаимодействия с сервисами биржевой информации - отправка команды на исполнение и отправка запроса на получение статуса.

## Скриншоты проекта

 Стартовая страница:
 
 ![start_page](https://imgur.com/xBUChuT.png)
 
 Выбор сервиса из списка, а также вкладка со списком команд:
 
 ![service_select](https://imgur.com/JjjDpoz.png)
 
 Вывод таблицы с данными (статуса сервиса), а также оценки задержки данных:
 
 ![service_status](https://imgur.com/zWguwH8.png)
 
 Отправляемые от клиента запросы можно отследить в консоли (для отладки):
 
 ![debug](https://imgur.com/RYL5pfJ.png)
 
 Адаптивный дизайн:
 
 ![adaptive_design](https://imgur.com/sNvduv1.png)

## Установка проекта на компьютер
Для установки проекта на свой компьютер необходимо выполнить следующие действия:
* Скачать и установить JDK версии не ниже 17: [Oracle](https://www.oracle.com/cis/java/technologies/downloads/#java17) или [OpenJDK](https://openjdk.org/projects/jdk/17/)
* Скачать и установить сборщик проектов [Maven](https://maven.apache.org/download.cgi)
* Скопировать репозиторий к себе на компьютер
* Открыть терминал, перейти в корневую папку скопированного репозитория и ввести команду:
```
mvn clean install
```

Данная команда запустит сборку проекта и скомпилирует исполняемый файл.
  
## Запуск проекта

* Откройте терминал, в терминале перейдите в корневую папку проекта. Для того, чтобы запустить приложение, можно воспользоваться следующей командой:
```
java -jar target/broker-terminal-0.0.1-SNAPSHOT.jar --id=$ID --port=$PORT
```

В качестве параметров принимаются два значения:

 * `$ID` - строковый параметр, обозначающий уникальный идентификатор TCP-сервера. Все сервисы биржевой информации должны указывать это значение в поле `receiver` заголовка сообщения;
 * `$PORT` - порт, прослушиваемый TCP-сервером. Все сервисы биржевой информации должны обращаться к TCP-серверу по этому порту.
 
Например, если необходимо запустить TCP-сервер с идентификатором _mySuperServer_ и портом _12345_, это можно сделать так:

```
java -jar target/broker-terminal-0.0.1-SNAPSHOT.jar --id="mySuperServer" --port=12345
```
 
Данные параметры можно не указывать. В таком случае будут использоваться значения по умолчанию. Например, можно ввести команду:
```
java -jar target/broker-terminal-0.0.1-SNAPSHOT.jar
``` 
В таком случае в качестве идентификатора будет использоваться _server_, а в качестве порта - _10000_.

Если вы запускаете приложение локально, то после ввода команды сервер запустится по адресу `127.0.0.1:8080` или `localhost:8080`. Откройте этот адрес в любом браузере.

## Тестирование

  При тестировании приложения стоит учитывать следующие моменты:
  * Сервис биржевой информации **обязан** указывать корректный `receiver` в заголовке запроса, соответствующий идентификатору TCP-сервера. По умолчанию он равен _server_, но его можно изменить с помощью консольного параметра `$ID`. Если `receiver` не равен идентификатору сервера, TCP-сервер будет игнорировать сервисы БИ;
  * У TCP-сервера есть свой тайм-аут на запросы к сервису биржевой информации (он равен 5 секундам). Если в течение этого времени сервис биржевой информации не отправляет ответ на запрос, TCP-сервер разрывает соединение с сервисом;
  * Прочие баги...
